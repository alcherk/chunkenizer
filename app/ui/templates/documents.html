{% extends "base.html" %}

{% block content %}
<div class="px-4 py-6 sm:px-0">
    <div class="bg-white shadow rounded-lg overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
            <h2 class="text-2xl font-bold text-gray-900">Ingested Documents</h2>
            <div class="flex items-center gap-4">
                <span id="selectionCount" class="text-sm text-gray-600 hidden">
                    <span id="selectedCount">0</span> document(s) selected
                </span>
                <button 
                    id="deleteSelectedBtn"
                    class="bg-red-600 text-white py-2 px-4 rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed"
                    disabled
                >
                    Delete Selected
                </button>
            </div>
        </div>
        
        <div id="message" class="hidden mx-6 mt-4"></div>
        
        {% if documents %}
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            <input 
                                type="checkbox" 
                                id="selectAllCheckbox"
                                class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                            >
                            <label for="selectAllCheckbox" class="ml-2 text-xs font-normal text-gray-700">Select All</label>
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Chunks</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tokens</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Created</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for doc in documents %}
                    <tr class="document-row" data-doc-id="{{ doc.id }}">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <input 
                                type="checkbox" 
                                class="document-checkbox h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                                value="{{ doc.id }}"
                                data-doc-name="{{ doc.name }}"
                            >
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ doc.name }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ doc.content_type }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ doc.chunk_count }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ doc.total_tokens }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ doc.created_at[:10] if doc.created_at else '-' }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                            <button 
                                onclick="deleteDocument('{{ doc.id }}', '{{ doc.name }}')"
                                class="text-red-600 hover:text-red-900"
                            >
                                Delete
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="px-6 py-8 text-center text-gray-500">
            No documents ingested yet. <a href="/" class="text-blue-600 hover:text-blue-800">Upload one</a>
        </div>
        {% endif %}
    </div>
</div>

<script>
// Selection management
let selectedDocumentIds = new Set();

function updateSelectionCount() {
    const count = selectedDocumentIds.size;
    const countSpan = document.getElementById('selectedCount');
    const selectionCountDiv = document.getElementById('selectionCount');
    const deleteBtn = document.getElementById('deleteSelectedBtn');
    
    if (countSpan) countSpan.textContent = count;
    
    if (count > 0) {
        selectionCountDiv.classList.remove('hidden');
        deleteBtn.disabled = false;
    } else {
        selectionCountDiv.classList.add('hidden');
        deleteBtn.disabled = true;
    }
    
    // Update select all checkbox state
    const selectAllCheckbox = document.getElementById('selectAllCheckbox');
    if (selectAllCheckbox) {
        const allCheckboxes = document.querySelectorAll('.document-checkbox');
        const checkedCount = document.querySelectorAll('.document-checkbox:checked').length;
        selectAllCheckbox.checked = allCheckboxes.length > 0 && checkedCount === allCheckboxes.length;
        selectAllCheckbox.indeterminate = checkedCount > 0 && checkedCount < allCheckboxes.length;
    }
}

// Attach checkbox listeners
document.addEventListener('DOMContentLoaded', () => {
    // Individual checkboxes
    document.querySelectorAll('.document-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', (e) => {
            const docId = e.target.value;
            if (e.target.checked) {
                selectedDocumentIds.add(docId);
                e.target.closest('tr').classList.add('bg-blue-50');
            } else {
                selectedDocumentIds.delete(docId);
                e.target.closest('tr').classList.remove('bg-blue-50');
            }
            updateSelectionCount();
        });
    });
    
    // Select all checkbox
    const selectAllCheckbox = document.getElementById('selectAllCheckbox');
    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', (e) => {
            const checkboxes = document.querySelectorAll('.document-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = e.target.checked;
                const docId = checkbox.value;
                const row = checkbox.closest('tr');
                
                if (e.target.checked) {
                    selectedDocumentIds.add(docId);
                    row.classList.add('bg-blue-50');
                } else {
                    selectedDocumentIds.delete(docId);
                    row.classList.remove('bg-blue-50');
                }
            });
            updateSelectionCount();
        });
    }
    
    // Delete selected button
    const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');
    if (deleteSelectedBtn) {
        deleteSelectedBtn.addEventListener('click', deleteSelected);
    }
});

async function deleteSelected() {
    const selectedIds = Array.from(selectedDocumentIds);
    
    if (selectedIds.length === 0) {
        return;
    }
    
    // Get document names for confirmation
    const selectedNames = selectedIds.map(id => {
        const checkbox = document.querySelector(`.document-checkbox[value="${id}"]`);
        return checkbox ? checkbox.getAttribute('data-doc-name') : id;
    }).filter(Boolean);
    
    // Confirmation dialog
    const confirmed = confirm(
        `Delete ${selectedIds.length} document(s)?\n\n${selectedNames.slice(0, 5).join('\n')}${selectedNames.length > 5 ? `\n...and ${selectedNames.length - 5} more` : ''}\n\nThis will delete all documents and their chunks. This action cannot be undone.`
    );
    
    if (!confirmed) {
        return;
    }
    
    // Show loading state
    const deleteBtn = document.getElementById('deleteSelectedBtn');
    const originalText = deleteBtn.textContent;
    deleteBtn.disabled = true;
    deleteBtn.textContent = 'Deleting...';
    
    try {
        const response = await fetch('/api/documents', {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                document_ids: selectedIds
            })
        });
        
        const result = await response.json();
        
        if (!response.ok) {
            throw new Error(result.detail || 'Failed to delete documents');
        }
        
        // Clear selection
        selectedDocumentIds.clear();
        updateSelectionCount();
        
        // Show success/error message
        const messageDiv = document.getElementById('message');
        if (messageDiv) {
            if (result.failed_count && result.failed_count > 0) {
                messageDiv.className = 'mx-6 mt-4 p-4 bg-yellow-50 border border-yellow-200 rounded-md';
                messageDiv.textContent = `Deleted ${result.deleted_count} document(s), but ${result.failed_count} failed. Check console for details.`;
            } else {
                messageDiv.className = 'mx-6 mt-4 p-4 bg-green-50 border border-green-200 rounded-md';
                messageDiv.textContent = `Successfully deleted ${result.deleted_count} document(s) and all their chunks.`;
            }
            messageDiv.classList.remove('hidden');
            
            // Hide message after 5 seconds
            setTimeout(() => {
                messageDiv.classList.add('hidden');
            }, 5000);
        }
        
        // Refresh page after a short delay
        setTimeout(() => {
            location.reload();
        }, 1500);
        
    } catch (error) {
        console.error('Error deleting documents:', error);
        
        // Show error message
        const messageDiv = document.getElementById('message');
        if (messageDiv) {
            messageDiv.className = 'mx-6 mt-4 p-4 bg-red-50 border border-red-200 rounded-md';
            messageDiv.textContent = `Error: ${error.message}`;
            messageDiv.classList.remove('hidden');
        }
    } finally {
        deleteBtn.disabled = false;
        deleteBtn.textContent = originalText;
    }
}

async function deleteDocument(docId, docName) {
    if (!confirm(`Are you sure you want to delete "${docName}"? This will delete the document and all its chunks. This action cannot be undone.`)) {
        return;
    }
    
    // Find the button and disable it
    const buttons = document.querySelectorAll(`button[onclick*="${docId}"]`);
    buttons.forEach(btn => {
        btn.disabled = true;
        btn.textContent = 'Deleting...';
        btn.classList.add('opacity-50', 'cursor-not-allowed');
    });
    
    try {
        const response = await fetch(`/api/documents/${docId}`, {
            method: 'DELETE'
        });
        
        const result = await response.json();
        
        if (response.ok) {
            // Show success message briefly before reload
            const messageDiv = document.getElementById('message');
            if (messageDiv) {
                messageDiv.className = 'mx-6 mt-4 p-4 bg-green-50 border border-green-200 rounded-md';
                messageDiv.textContent = `Document "${docName}" deleted successfully`;
                messageDiv.classList.remove('hidden');
            }
            
            setTimeout(() => {
                location.reload();
            }, 1000);
        } else {
            // Show error message
            const messageDiv = document.getElementById('message');
            if (messageDiv) {
                messageDiv.className = 'mx-6 mt-4 p-4 bg-red-50 border border-red-200 rounded-md';
                messageDiv.textContent = `Error: ${result.detail || 'Failed to delete document'}`;
                messageDiv.classList.remove('hidden');
            }
            
            // Re-enable button
            buttons.forEach(btn => {
                btn.disabled = false;
                btn.textContent = 'Delete';
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
            });
        }
    } catch (error) {
        // Show error message
        const messageDiv = document.getElementById('message');
        if (messageDiv) {
            messageDiv.className = 'mx-6 mt-4 p-4 bg-red-50 border border-red-200 rounded-md';
            messageDiv.textContent = `Error: ${error.message}`;
            messageDiv.classList.remove('hidden');
        }
        
        // Re-enable button
        buttons.forEach(btn => {
            btn.disabled = false;
            btn.textContent = 'Delete';
            btn.classList.remove('opacity-50', 'cursor-not-allowed');
        });
    }
}
</script>
{% endblock %}

