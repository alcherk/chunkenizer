{% extends "base.html" %}

{% block content %}
<div class="px-4 py-6 sm:px-0">
    <div class="bg-white shadow rounded-lg p-6">
        <h2 class="text-2xl font-bold text-gray-900 mb-6">Upload Documents</h2>
        
        <form id="uploadForm" enctype="multipart/form-data" class="space-y-4">
            <div>
                <label for="file" class="block text-sm font-medium text-gray-700 mb-2">
                    Select Files (md, txt, json)
                </label>
                <input 
                    type="file" 
                    id="file" 
                    name="file" 
                    multiple 
                    accept=".md,.txt,.json,text/*,application/json"
                    class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
                    required
                >
            </div>
            
            <div>
                <label for="metadata_json" class="block text-sm font-medium text-gray-700 mb-2">
                    Metadata JSON (optional)
                </label>
                <textarea 
                    id="metadata_json" 
                    name="metadata_json" 
                    rows="3"
                    placeholder='{"source": "example", "category": "docs"}'
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                ></textarea>
            </div>
            
            <div class="flex items-center">
                <input 
                    type="checkbox" 
                    id="force_reindex" 
                    name="force_reindex"
                    class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                >
                <label for="force_reindex" class="ml-2 block text-sm text-gray-700">
                    Force reindex (if document already exists)
                </label>
            </div>
            
            <button 
                type="submit" 
                class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
            >
                Upload
            </button>
        </form>
        
        <div id="message" class="mt-4 hidden"></div>
        <div id="progress" class="mt-4 hidden">
            <div class="bg-gray-200 rounded-full h-2.5">
                <div id="progressBar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
            </div>
        </div>
    </div>
</div>

<script>
document.getElementById('uploadForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const messageDiv = document.getElementById('message');
    const progressDiv = document.getElementById('progress');
    const progressBar = document.getElementById('progressBar');
    
    messageDiv.classList.add('hidden');
    progressDiv.classList.remove('hidden');
    progressBar.style.width = '0%';
    
    try {
        const files = document.getElementById('file').files;
        let uploaded = 0;
        const total = files.length;
        
        for (let file of files) {
            const fileFormData = new FormData();
            fileFormData.append('file', file);
            if (formData.get('metadata_json')) {
                fileFormData.append('metadata_json', formData.get('metadata_json'));
            }
            if (formData.get('force_reindex')) {
                fileFormData.append('force_reindex', 'true');
            }
            
            const response = await fetch('/documents', {
                method: 'POST',
                body: fileFormData
            });
            
            const result = await response.json();
            
            if (!response.ok) {
                throw new Error(result.detail || 'Upload failed');
            }
            
            uploaded++;
            progressBar.style.width = `${(uploaded / total) * 100}%`;
        }
        
        progressDiv.classList.add('hidden');
        messageDiv.className = 'mt-4 p-4 bg-green-50 border border-green-200 rounded-md';
        messageDiv.textContent = `Successfully uploaded ${uploaded} file(s)`;
        messageDiv.classList.remove('hidden');
        
        e.target.reset();
        
    } catch (error) {
        progressDiv.classList.add('hidden');
        messageDiv.className = 'mt-4 p-4 bg-red-50 border border-red-200 rounded-md';
        messageDiv.textContent = `Error: ${error.message}`;
        messageDiv.classList.remove('hidden');
    }
});
</script>
{% endblock %}

